<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAFhr8C3o6fEXY1vNkiKq_0tfXp45ekTlU",
    authDomain: "woodydashboard.firebaseapp.com",
    projectId: "woodydashboard",
    storageBucket: "woodydashboard.appspot.com",
    messagingSenderId: "180582118415",
    appId: "1:180582118415:web:447bdf09b42dd16fa15f7a"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  async function saveNotes(tab) {
    const content = document.getElementById(`notes-${tab}`).value;
    const statusEl = document.getElementById(`saveStatus-${tab}`);
    try {
      await setDoc(doc(db, "dashboardNotes", tab), { content });
      console.log(`[SAVED] ${tab}:`, content);
      statusEl.textContent = "✔ Saved!";
      statusEl.style.opacity = 1;
    } catch (err) {
      console.error("Error saving notes:", err);
      statusEl.textContent = "❌ Save failed!";
      statusEl.style.opacity = 1;
    }
    setTimeout(() => {
      statusEl.style.opacity = 0;
    }, 2000);
  }

  async function loadNotes(tab) {
    try {
      const snap = await getDoc(doc(db, "dashboardNotes", tab));
      if (snap.exists()) {
        const data = snap.data();
        console.log(`[LOADED] ${tab}:`, data.content);
        document.getElementById(`notes-${tab}`).value = data.content;
      } else {
        console.log(`[LOADED] ${tab}: No data found`);
      }
    } catch (err) {
      console.error(`Error loading notes for ${tab}:`, err);
    }
  }

  const tabs = ["work", "personal", "secondjob", "charity"];
  tabs.forEach(loadNotes);

  function updateClocks() {
    const clocks = [
      { city: "Shanghai", timeZone: "Asia/Shanghai" },
      { city: "Chennai", timeZone: "Asia/Kolkata" },
      { city: "London", timeZone: "Europe/London" },
      { city: "New York", timeZone: "America/New_York" },
      { city: "Dallas", timeZone: "America/Chicago" },
      { city: "Honolulu", timeZone: "Pacific/Honolulu" }
    ];
    const container = document.getElementById("world-clocks");
    container.innerHTML = clocks.map(({ city, timeZone }) => {
      const now = new Date().toLocaleTimeString("en-US", {
        timeZone,
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
      return `<div class="clock-card">
                <h4>${city}</h4>
                <div class="time">${now}</div>
              </div>`;
    }).join("");
  }

  setInterval(updateClocks, 1000);
  updateClocks();

  document.querySelectorAll("nav button").forEach(btn => {
    btn.addEventListener("click", () => {
      const target = btn.dataset.tab;
      document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
      document.getElementById(target).classList.add("active");

      document.querySelectorAll("nav button").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
    });
  });

  // DARK MODE
  const darkToggle = document.getElementById("darkModeToggle");
  const themeLabel = document.getElementById("theme-label");

  function applyDarkMode(isDark) {
    document.body.classList.toggle("dark", isDark);
    darkToggle.checked = isDark;
    themeLabel.textContent = isDark ? "🌙" : "🌞";
  }

  // Load from localStorage or use system preference
  const savedTheme = localStorage.getItem("theme");
  const systemPrefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
  const isDarkMode = savedTheme ? savedTheme === "dark" : systemPrefersDark;
  applyDarkMode(isDarkMode);

  darkToggle.addEventListener("change", () => {
    const isDark = darkToggle.checked;
    applyDarkMode(isDark);
    localStorage.setItem("theme", isDark ? "dark" : "light");
  });

  // Allow HTML inline event calls
  window.saveNotes = saveNotes;
</script>
